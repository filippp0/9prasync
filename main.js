(()=>{"use strict";class t{constructor(t,e,s,i,n){this._link=t.link,this._name=t.name,this._cardId=t._id,this._myId=t.myid,this._ownerId=t.owner._id,this._likes=t.likes,this._likesLength=t.likes.length,this._changeLike=n,this._openImagePopup=s,this._openDelete=i,this._cloneElement=document.querySelector(e).content.querySelector(".elements__list").cloneNode(!0),this._imageElement=this._cloneElement.querySelector(".elements__image"),this._likeIconElement=this._cloneElement.querySelector(".elements__like-icon"),this._trashElement=this._cloneElement.querySelector(".elements__trash"),this._subTitle=this._cloneElement.querySelector(".elements__subtitle"),this._counter=this._cloneElement.querySelector(".elements__counter")}_handleLike=()=>{this._changeLike(this._likeIconElement,this._cardId,this._counter)};_handleDeleteElement=()=>{this._openDelete({cardId:this._cardId,card:this})};_handleOpenImageInPopupImage=()=>{this._openImagePopup({title:this._name,link:this._link})};_setEventListener(){this._likeIconElement.addEventListener("click",this._handleLike),this._trashElement.addEventListener("click",this._handleDeleteElement),this._imageElement.addEventListener("click",this._handleOpenImageInPopupImage)}_checkLikeStatus(){this._likes.forEach((t=>{t._id!==this._myId||this._likeIconElement.classList.add("elements__like-icon_active")})),this._counter.textContent=this._likesLength}_changeVisibleForTrashButton(){this._myId===this._ownerId?this._trashElement.style.display="block":this._trashElement.style.display="none"}removeCard=()=>{this._cloneElement.remove(),this._cloneElement=null};toggelLike(t){this._likeIconElement.classList.toggle("elements__like-icon_active"),this._counter.textContent=t.length}createCard(){return this._imageElement.src=this._link,this._imageElement.alt=`Изображение ${this._name}`,this._subTitle.textContent=this._name,this._checkLikeStatus(),this._changeVisibleForTrashButton(),this._setEventListener(),this._cloneElement}}class e{constructor(t,e){this._inputSelector=t.inputSelector,this._submitButtonSelector=t.submitButtonSelector,this._errorSelectorTemplate=t.errorSelectorTemplate,this._disableButtonClass=t.disableButtonClass,this._inputErrorClass=t.inputErrorClass,this._form=e,this._button=e.querySelector(t.submitButtonSelector),this._inputList=e.querySelectorAll(t.inputSelector)}_showInputError(){this._input.classList.add(this._inputErrorClass),this._errorTextElement.textContent=this._input.validationMessage}_hideInputError(){this._input.classList.remove(this._inputErrorClass),this._errorTextElement.textContent=""}_enableButton(){this._button.classList.remove(this._disableButtonClass),this._button.disabled=!1}_disableButton(){this._button.classList.add(this._disableButtonClass),this._button.disabled=!0}_hasValidInput(){return Array.from(this._inputList).every((t=>t.validity.valid))}_toggleButtonState(){this._hasValidInput()?this._enableButton():this._disableButton()}_checkInputValidity(){this._errorTextElement=this._form.querySelector(`${this._errorSelectorTemplate}${this._input.name}`),this._input.validity.valid?this._hideInputError():this._showInputError()}_setEventListener(){this._inputList.forEach((t=>{t.addEventListener("input",(()=>{this._input=t,this._checkInputValidity(),this._toggleButtonState()}))}))}enableValidation(){this._setEventListener()}resetErrorForOpenForm(){this._inputList.forEach((t=>{this._input=t,this._errorTextElement=this._form.querySelector(`${this._errorSelectorTemplate}${t.name}`),t.validity.valid||this._hideInputError()})),this._disableButton()}}class s{constructor(t){this._popup=document.querySelector(t),this._popupCloseButton=this._popup.querySelector(".popup__close-icon"),this.submitButton=this._popup.querySelector(".popup__submit")}_handleEscClose=t=>{"Escape"===t.key&&this.close()};_handleCloseButton=()=>{this.close()};_handleClickByOverlay=t=>{t.target===t.currentTarget&&this.close()};setEventListeners(){this._popup.addEventListener("mousedown",this._handleClickByOverlay),this._popupCloseButton.addEventListener("click",this._handleCloseButton)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}}class i extends s{constructor(t,e){super(t),this._submitFunction=e,this._form=this._popup.querySelector(".popup__form"),this._inputList=this._form.querySelectorAll(".popup__input"),this._submitButton=this._popup.querySelector(".popup__submit"),this._defaultButtonText=this._submitButton.textContent}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault(),this.submitButton.textContent=`${this.submitButton.textContent}...`,this._submitFunction(this._getInputsValue())}))}_getInputsValue(){return this._values={},this._inputList.forEach((t=>{this._values[t.name]=t.value})),this._values}setInputsValue(t){this._inputList.forEach((e=>{e.value=t[e.name]}))}setupText(t,e){this._submitButton.textContent=t?e:this._defaultButtonText}close(){super.close(),this._form.reset()}}const n=document.querySelector(".profile__edit"),r=document.querySelector(".profile__add-button"),o=document.querySelector(".profile__avatar-overlay"),a={},l={inputSelector:".popup__input",submitButtonSelector:".popup__submit",errorSelectorTemplate:".popup__error_type_",disableButtonClass:"popup__submit_disable",inputErrorClass:"popup__input_invalid"},h=new class{constructor(t){this._url=t.baseUrl,this._headers=t.headers,this._authorization=t.headers.authorization}_checkResponse(t){return t.ok?t.json():Promise.reject}async getInfo(){const t=await fetch(`${this._url}/users/me`,{headers:{authorization:this._authorization}});return this._checkResponse(t)}async setUserInfo(t){const e=await fetch(`${this._url}/users/me`,{method:"PATCH",headers:this._headers,body:JSON.stringify({name:t.username,about:t.job})});return this._checkResponse(e)}async getCards(){const t=await fetch(`${this._url}/cards`,{headers:{authorization:this._authorization}});return this._checkResponse(t)}async addCard(t){const e=await fetch(`${this._url}/cards`,{method:"POST",headers:this._headers,body:JSON.stringify({name:t.title,link:t.link})});return this._checkResponse(e)}async setNewAvatar(t){const e=await fetch(`${this._url}/users/me/avatar`,{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:t.avatar})});return this._checkResponse(e)}async deleteCard(t){const e=await fetch(`${this._url}/cards/${t}`,{method:"DELETE",headers:{authorization:this._authorization}});return this._checkResponse(e)}async deleteLike(t){const e=await fetch(`${this._url}/cards/${t}/likes`,{method:"DELETE",headers:{authorization:this._authorization}});return this._checkResponse(e)}async addLike(t){const e=await fetch(`${this._url}/cards/${t}/likes`,{method:"PUT",headers:{authorization:this._authorization}});return this._checkResponse(e)}}({baseUrl:"https://mesto.nomoreparties.co/v1/cohort-66",headers:{authorization:"9f4d5ff3-f724-49c2-9657-4a12392beeb3","Content-Type":"application/json"}}),u=new class{constructor(t){this._profileName=document.querySelector(t.profileNameSelector),this._profileJob=document.querySelector(t.profileJobSelector),this.profileAvatar=document.querySelector(t.profileAvatarSelector)}getUserInfo(){return{username:this._profileName.textContent,job:this._profileJob.textContent}}setUserInfo({name:t,job:e,avatar:s}){this.profileAvatar.src=s,this._profileName.textContent=t,this._profileJob.textContent=e}}({profileNameSelector:".profile__name",profileJobSelector:".profile__job",profileAvatarSelector:".profile__avatar"}),c=new class extends s{constructor(t){super(t),this._popupImage=this._popup.querySelector(".image-popup__image"),this._imagePopupCaption=this._popup.querySelector(".image-popup__image-caption")}open=t=>{this._popupImage.src=t.link,this._popupImage.alt=`Изображение ${t.title}`,this._imagePopupCaption.textContent=t.title,super.open()}}(".image-popup");function _(e){const s=new t(e,"#cardElement",c.open,f.open,(async(t,e)=>{if(t.classList.contains("elements__like-icon_active"))try{const t=await h.deleteLike(e);s.toggelLike(t.likes)}catch(t){console.error(`Ошибка при снятии лайка ${t}`)}else try{const t=await h.addLike(e);s.toggelLike(t.likes)}catch(t){console.error(`Ошибка при добавлении лайка ${t}`)}}));return s.createCard()}async function p(t,e,s="Ошибка",i="Сохранение..."){try{e.setupText(!0,i),await t(),e.close()}catch(t){console.error(`${s} ${t}`)}finally{e.setupText(!1)}}const d=new class{constructor(t,e){this._container=document.querySelector(e),this._renderer=t}addCardFromArray(t){t.forEach((t=>{this._renderer(t)}))}addItemPrepend(t){this._container.prepend(t)}addItemAppend(t){this._container.append(t)}}((t=>{d.addItemAppend(_(t))}),".elements__lists"),m=new i(".profile-popup",(t=>{p((async function(){const e=await h.setUserInfo(t);u.setUserInfo({name:e.name,job:e.about,avatar:e.avatar})}),m,"Ошибка при редактировании профиля")})),E=new i(".card-popup",(t=>{p((async function(){const[e,s]=await Promise.all([h.getInfo(),h.addCard(t)]);s.myid=e._id,d.addItemPrepend(_(s))}),E,"Ошибка при создании новой карточки","Создание...")})),y=new i(".edit-avatar-popup",(t=>{p((async function(){const e=await h.setNewAvatar(t);u.setUserInfo({name:e.name,job:e.about,avatar:e.avatar})}),y,"Ошибка при обновлении аватара")})),f=new class extends s{constructor(t,e){super(t),this._submitFunction=e,this._form=this._popup.querySelector(".popup__form"),this._submitButton=this._popup.querySelector(".popup__submit"),this._defaultButtonText=this._submitButton.textContent}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(t=>{t.preventDefault(),this.submitButton.textContent=`${this.submitButton.textContent}...`,this._submitFunction({card:this._card,cardId:this._cadrId})}))}setupText(t,e){this._submitButton.textContent=t?e:this._defaultButtonText}open=({cardId:t,card:e})=>{super.open(),this._card=e,this._cadrId=t}}(".delete-popup",(({card:t,cardId:e})=>{p((async function(){await h.deleteCard(e),t.removeCard()}),f,"Ошибка при удалении карточки","Удаление...")}));Array.from(document.forms).forEach((t=>{const s=new e(l,t),i=t.getAttribute("name");a[i]=s,s.enableValidation()})),c.setEventListeners(),m.setEventListeners(),E.setEventListeners(),f.setEventListeners(),y.setEventListeners(),n.addEventListener("click",(()=>{a.personalData.resetErrorForOpenForm(),m.setInputsValue(u.getUserInfo()),m.open()})),r.addEventListener("click",(()=>{a.addCard.resetErrorForOpenForm(),E.open()})),o.addEventListener("click",(()=>{a.editAvatar.resetErrorForOpenForm(),y.open()})),(async()=>{try{const[t,e]=await Promise.all([h.getInfo(),h.getCards()]);e.forEach((e=>e.myid=t._id)),u.setUserInfo({name:t.name,job:t.about,avatar:t.avatar}),d.addCardFromArray(e)}catch(t){console.error(`Ошибка при создании начальных данных страницы ${t}`)}})()})();